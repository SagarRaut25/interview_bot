<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEX AI Interview</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #222831;
            color: #DFD0B8;
        }
        .camera-feed {
            border-radius: 10px;
            object-fit: cover;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .bot-message {
            background-color: #2c2f36;
            align-self: flex-start;
        }
        .user-message {
            background-color: #3a4750;
            align-self: flex-end;
        }
        #micButton.recording {
            background-color: #E52437;
            color: white;
        }
        #micButton.paused {
            background-color: #FFA500;
            color: white;
        }
        @keyframes blink {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        #conversationBox {
            scrollbar-width: thin;
            scrollbar-color: #DFD0B8 #2c2f36;
        }
        #conversationBox::-webkit-scrollbar {
            width: 8px;
        }
        #conversationBox::-webkit-scrollbar-track {
            background: #2c2f36;
        }
        #conversationBox::-webkit-scrollbar-thumb {
            background-color: #DFD0B8;
            border-radius: 10px;
        }
        .report-header {
            background-color: #393e46;
            color: #DFD0B8;
        }
        .report-modal .modal-content {
            background-color: #2c2f36;
            color: #DFD0B8;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="col-md-12 d-flex align-items-center" 
         style="padding: 5px; background-color: #495057; height: 40px; width: 30%; 
                border-radius: 15px; margin: 15px auto; 
                box-shadow: 0 4px 10px rgba(223, 204, 130, 0.701); justify-content: center;">
        <img src="/static/media/botImage.png" 
             alt="Bot Logo" 
             style="width: 50px; height: 50px; margin-right: 15px;" />
        <h1 style="margin: 0; color: #DFD0B8; font-size: 1.4rem;">NEX AI</h1>
    </div>

    <!-- Setup Section -->
    <div class="container mt-5 setup-section" style="width: 90%;">
        <div class="row w-100 rounded mx-auto" style="background-color: #495057; box-shadow: 0 2px 5px rgba(223, 204, 130, 0.701); height: 500px;">
            <!-- Left Column -->
            <div class="col-md-6 p-4 d-flex flex-column justify-content-between">
                <!-- Info & Features -->
                <div class="p-3 rounded" style="background-color: #393e46;">
                    <p class="mb-0" style="color: #DFD0B8; font-size: 1.3rem;">
                        <strong>Hey {{ data.candidate_name }}!</strong>
                    </p>
                    <p class="mb-2" style="color: #DFD0B8; font-size: 1rem;">
                        Welcome to your virtual interview with our <strong>AI-powered assistant</strong>.
                    </p>
                    <p class="mb-1" style="font-size: 0.95rem; color: #DFD0B8;">
                        <strong>Organization:</strong> {{ data.organization_name or 'N/A' }}
                    </p>
                    <p class="mb-1" style="font-size: 0.95rem; color: #DFD0B8;">
                        <strong>Job Title:</strong> {{ data.job_title or 'N/A' }}
                    </p>
                    <p class="mb-1" style="font-size: 0.95rem; color: #DFD0B8;">
                        <strong>Email:</strong> {{ data.email or 'N/A' }}
                    </p>
                    <p class="mt-2" style="font-size: 0.9rem; color: #aaaaaa;">
                        Please ensure you're prepared — your responses will help us evaluate your fit for this role.
                    </p>

                    <!-- Key Features -->
                    <div class="mt-4 p-3 rounded" style="background-color: #2c2f36;">
                        <h5 style="color: #DFD0B8; font-size: 1.1rem;">🔑 Key Features to Know Before Starting</h5>
                        <ul style="color: #DFD0B8; font-size: 0.95rem; padding-left: 1.2rem; margin-top: 10px;">
                            <li>AI that guides you through a series of tasks</li>
                            <li>Give us your honest feedback</li>
                            <li>You can ask the AI for help at any point</li>
                            <li>Perform tasks and answer the questions</li>
                        </ul>
                    </div>
                </div>

                <!-- Interview Settings -->
                <div class="mt-3">
                    <label for="role" class="form-label text-light"><strong>Select Role</strong></label>
                    <select class="form-select mb-3" id="role" style="background-color: #2c2f36; color: #DFD0B8;">
                        <option value="software_engineer">Software Engineer</option>
                        <option value="data_scientist">Data Scientist</option>
                        <option value="product_manager">Product Manager</option>
                    </select>

                    <div class="mb-3">
                        <label class="form-label text-light"><strong>Experience Level</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="experienceLevel" id="fresher" value="fresher" checked>
                            <label class="form-check-label text-light" for="fresher">Fresher</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="experienceLevel" id="experienced" value="experienced">
                            <label class="form-check-label text-light" for="experienced">Experienced</label>
                        </div>
                    </div>

                    <!-- Hidden Experience Field -->
                    <div id="experienceFields" class="mb-3" style="display: none;">
                        <label for="yearsExperience" class="form-label text-light"><strong>Years of Experience</strong></label>
                        <input type="number" class="form-control" id="yearsExperience" min="1" max="30" value="3" style="background-color: #2c2f36; color: #DFD0B8;">
                    </div>

                    <!-- Question Count -->
                    <div class="mb-3">
                        <label for="numQuestions" class="form-label text-light">
                            <strong>Number of Questions: </strong><span id="questionCount">5</span>
                        </label>
                        <input type="range" class="form-range" id="numQuestions" min="3" max="10" value="5">
                    </div>
                </div>

                <!-- Start Interview Button -->
                <button type="button" id="startInterviewBtn" class="btn btn-sm mt-3"
                        style="background-color: #222831; color: #dfd0b8;">
                    <i class="fas fa-play"></i> Start Interview
                </button>
            </div>
           
            <!-- Right Column: Camera -->
            <div class="col-md-6 d-flex justify-content-center align-items-center p-0" style="height: 500px;">
                <video id="cameraFeed" class="camera-feed mx-auto"
                     autoplay playsinline
                     style="width: 90%; height: 90%; border-radius: 10px; object-fit: cover;">
                </video>
            </div>
        </div>
    </div>

    <!-- Interview Section (Hidden Initially) -->
    <div class="container-fluid interview-section" style="display: none; background-color: #222831; min-height: 100vh; padding: 2rem;">
        <div class="row rounded shadow-lg" style="background-color: #393e46; height: 90vh; overflow: hidden; display: flex;">
            <!-- Left Panel: AI Bot + Transcript -->
            <div class="col-md-6 d-flex flex-column justify-content-start align-items-center p-4" style="background-color: #393e46; border-right: 2px solid #2c2f36;">
                <!-- AI Bot Icon -->
                <div class="mb-3 text-center">
                    <img id="aiBotIcon" src="/static/media/botImage.png" alt="AI Bot"
                         style="width: 80px; height: 80px; animation: blink 1s infinite alternate;">
                </div>

                <!-- Conversation Box -->
                <div id="conversationContainer" class="w-100 mb-3 rounded p-3" style="background-color: #2c2f36; color: #DFD0B8; flex-grow: 1; overflow-y: auto;">
                    <!-- Messages will appear here dynamically -->
                </div>

                <!-- Answer Preview -->
                <div id="answerPreview" class="w-100 mt-2 p-2 rounded" style="background-color: #2c2f36; color: #DFD0B8; min-height: 60px; font-style: italic;">
                    Your answer will appear here...
                </div>
                
                <!-- Microphone Button -->
                <div class="d-flex justify-content-center mt-3 w-100">
                    <button class="btn btn-dark w-100" id="micButton" style="color: #DFD0B8; padding: 15px 30px; font-size: 1.25rem; border-radius: 50px;">
                        <i class="fas fa-microphone"></i> Speak
                    </button>
                </div>
            </div>

            <!-- Right Panel: Camera and Progress -->
            <div class="col-md-6 d-flex flex-column justify-content-between align-items-center p-4 text-center">
                <!-- Camera Feed -->
                <div class="camera-container w-100" style="flex-grow: 1;">
                    <video id="activeCameraFeed" class="camera-feed" autoplay playsinline
                           style="width: 100%; height: 65vh; object-fit: cover; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.4);">
                    </video>
                </div>

                <!-- Progress Display -->
                <div class="progress-container w-100 mt-3">
                    <div id="progressTextDisplay" class="text-light mb-1">0% Complete</div>
                    <div class="progress mb-2" style="height: 10px;">
                        <div id="progressBar" class="progress-bar bg-success" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-light">
                        Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">5</span>
                    </div>
                </div>

                <!-- Footer Buttons -->
                <div class="d-flex justify-content-between align-items-center w-100 mt-3">
                    <button id="endSessionBtn" class="btn btn-danger">End Session</button>
                    <button id="submitAnswerBtn" class="btn btn-primary">Submit Answer</button>
                </div>

                <!-- Interview Completion Message -->
                <div id="interviewCompleteMessage" class="interview-complete-message mt-3" style="color: #DFD0B8; display: none;">
                    Interview completed! Thank you for participating.
                    <br>
                    <button id="viewReportBtn" class="btn btn-outline-success btn-sm mt-2">
                        <i class="fas fa-chart-bar"></i> View Performance Report
                    </button>
                    <button id="startNewInterviewBtn" class="btn btn-outline-primary btn-sm mt-2">
                        <i class="fas fa-redo"></i> Start New Interview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg report-modal">
            <div class="modal-content">
                <div class="modal-header report-header">
                    <h5 class="modal-title" id="reportModalLabel">Interview Evaluation Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="report-content" id="reportContent">
                        Loading report...
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printReportBtn">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button type="button" class="btn btn-success" id="downloadReportBtn">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

    <!-- Main Application Script -->
    <script>
        $(document).ready(function() {
            // Global variables
            let recognition;
            let isRecording = false;
            let interviewInProgress = false;
            let autoStartRecording = true;
            let mediaStream = null;
            let totalSeconds = 1800; // 30 minutes for interview
            let timerInterval;
            let currentAnswer = '';
            let pauseCheckInterval;
            let lastActivityTime;
            let submittingAnswer = false;
            let currentQuestionAudio;

            // Initialize UI elements
            $('#interviewCompleteMessage').hide();
            $('#startNewInterviewBtn').hide();
            $('.interview-section').hide();

            // Show/hide experience fields based on selection
            $('input[name="experienceLevel"]').change(function() {
                if ($('#experienced').is(':checked')) {
                    $('#experienceFields').show();
                } else {
                    $('#experienceFields').hide();
                }
            });

            // Update question count display
            $('#numQuestions').on('input', function() {
                $('#questionCount').text($(this).val());
            });

            // Initialize camera
            async function initCamera() {
                try {
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                    }
                    
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: "user"
                        },
                        audio: false
                    });
                    
                    const cameraFeed = document.getElementById('cameraFeed');
                    const activeCameraFeed = document.getElementById('activeCameraFeed');
                    
                    if (cameraFeed) cameraFeed.srcObject = mediaStream;
                    if (activeCameraFeed) activeCameraFeed.srcObject = mediaStream;
                    
                    return true;
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    return false;
                }
            }

            // Start camera when page loads
            initCamera();

            // Start interview
            $('#startInterviewBtn').click(async function() {
                const role = $('#role').val();
                const numQuestions = $('#numQuestions').val();
                const experienceLevel = $('input[name="experienceLevel"]:checked').val();
                const yearsExperience = experienceLevel === 'experienced' ? $('#yearsExperience').val() : 0;
                
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');
                
                // Start camera if not already started
                const cameraStarted = await initCamera();
                if (!cameraStarted) {
                    alert('Could not access camera. Please enable camera permissions.');
                    $(this).prop('disabled', false).html('<i class="fas fa-play"></i> Start Interview');
                    return;
                }
                
                $.ajax({
                    url: '/start_interview',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        role: role,
                        num_questions: numQuestions,
                        experience_level: experienceLevel,
                        years_experience: yearsExperience
                    }),
                    success: function(response) {
                        if (response.status === 'started') {
                            $('.setup-section').hide();
                            $('.interview-section').show();
                            $('#totalQuestions').text(response.total_questions);
                            interviewInProgress = true;
                            startTimer();
                            askQuestion();
                        }
                    },
                    error: function(xhr) {
                        alert('Error starting interview: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    },
                    complete: function() {
                        $('#startInterviewBtn').prop('disabled', false).html('<i class="fas fa-play"></i> Start Interview');
                    }
                });
            });

            // Timer functions
            function startTimer() {
                clearInterval(timerInterval);
                const timerDisplay = document.createElement('div');
                timerDisplay.id = 'interviewTimer';
                timerDisplay.style.position = 'fixed';
                timerDisplay.style.top = '10px';
                timerDisplay.style.right = '10px';
                timerDisplay.style.backgroundColor = '#E52437';
                timerDisplay.style.color = 'white';
                timerDisplay.style.padding = '10px 15px';
                timerDisplay.style.borderRadius = '8px';
                timerDisplay.style.zIndex = 1000;
                document.body.appendChild(timerDisplay);

                function updateTimer() {
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    timerDisplay.textContent = `⏱️ ${minutes}:${seconds < 10 ? '0' : ''}${seconds} remaining`;

                    if (totalSeconds <= 0) {
                        clearInterval(timerInterval);
                        endInterviewDueToTimeout();
                    }

                    totalSeconds--;
                }

                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            }

            function endInterviewDueToTimeout() {
                $('#interviewCompleteMessage').show().text("Interview complete. Time is up!");
                $('#startNewInterviewBtn').show();
                $('.interview-section').hide();
                clearInterval(timerInterval);
                document.getElementById('interviewTimer')?.remove();

                // Stop camera and recording
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
            }

            // Speech recognition setup
            function setupSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Your browser does not support speech recognition. Please use Chrome or Edge.');
                    $('#micButton').prop('disabled', true);
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                recognition.lang = 'en-US';

                recognition.onaudiostart = function() {
                    isRecording = true;
                    $('#micButton').addClass('recording');
                    lastActivityTime = Date.now();
                    startPauseDetection();
                };

                recognition.onsoundend = function() {
                    lastActivityTime = Date.now();
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    if (event.error !== 'no-speech') {
                        isRecording = false;
                        $('#micButton').removeClass('recording');
                        stopPauseDetection();
                    }
                };

                recognition.onend = function() {
                    isRecording = false;
                    $('#micButton').removeClass('recording');
                    
                    if (interviewInProgress && !$('#pauseDialog').length && !submittingAnswer) {
                        try {
                            setTimeout(() => recognition.start(), 300);
                        } catch(e) {
                            console.error('Error restarting recognition:', e);
                        }
                    }
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    lastActivityTime = Date.now();
                    
                    if (interimTranscript) {
                        $('#answerPreview').text(currentAnswer + ' ' + interimTranscript);
                    }
                    
                    if (finalTranscript) {
                        currentAnswer += ' ' + finalTranscript;
                        $('#answerPreview').text(currentAnswer);
                    }
                };
            }

            // Initialize speech recognition
            setupSpeechRecognition();

            // Pause detection functions
            function startPauseDetection() {
                stopPauseDetection();
                pauseCheckInterval = setInterval(checkForPause, 1000);
            }

            function stopPauseDetection() {
                if (pauseCheckInterval) {
                    clearInterval(pauseCheckInterval);
                    pauseCheckInterval = null;
                }
            }

            function checkForPause() {
                if (!isRecording || !interviewInProgress) return;
                
                const timeSinceActivity = Date.now() - lastActivityTime;
                if (timeSinceActivity > 5000 && !$('#pauseDialog').length) {
                    stopPauseDetection();
                    
                    if (isRecording) {
                        recognition.stop();
                    }
                    
                    const dialogHtml = `
                    <div id="pauseDialog" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="bg-white p-4 rounded shadow" style="max-width: 400px;">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-question-circle text-warning me-2" style="font-size: 24px;"></i>
                                <h5 class="mb-0">Are you still there?</h5>
                            </div>
                            <p>Would you like to continue with your answer or move to the next question?</p>
                            <div class="progress mb-3">
                                <div id="pauseDialogTimer" class="progress-bar bg-warning" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button id="continueAnswerBtn" class="btn btn-primary me-2">
                                    <i class="fas fa-microphone me-1"></i> Continue Answer
                                </button>
                                <button id="nextQuestionBtn" class="btn btn-secondary">
                                    <i class="fas fa-forward me-1"></i> Next Question
                                </button>
                            </div>
                        </div>
                    </div>`;
                    
                    $('body').append(dialogHtml);
                    
                    let timeLeft = 10;
                    const timerInterval = setInterval(() => {
                        timeLeft--;
                        const percent = (timeLeft / 10) * 100;
                        $('#pauseDialogTimer').css('width', percent + '%');
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                        }
                    }, 1000);
                    
                    $('#continueAnswerBtn').click(function() {
                        clearInterval(timerInterval);
                        $('#pauseDialog').remove();
                        const previewText = $('#answerPreview').text().trim();
                        if (previewText && !currentAnswer.includes(previewText)) {
                            currentAnswer = previewText;
                        }
                        lastActivityTime = Date.now();
                        startRecording();
                        startPauseDetection();
                    });
                    
                    $('#nextQuestionBtn').click(function() {
                        clearInterval(timerInterval);
                        $('#pauseDialog').remove();
                        if (currentAnswer.trim()) {
                            processAnswer(currentAnswer.trim());
                            currentAnswer = '';
                        } else {
                            askQuestion();
                        }
                    });
                    
                    setTimeout(function() {
                        if ($('#pauseDialog').length) {
                            clearInterval(timerInterval);
                            $('#nextQuestionBtn').click();
                        }
                    }, 10000);
                }
            }

            // Interview flow functions
            function askQuestion() {
                if (!interviewInProgress || totalSeconds <= 0) return;

                $.get('/get_question', function(response) {
                    if (response.status === 'completed' || totalSeconds <= 0) {
                        interviewComplete();
                    } else if (response.status === 'success') {
                        $('#currentQuestionNum').text(response.question_number);
                        updateProgress(response.question_number - 1, response.total_questions);
                        addMessage('bot', response.text);

                        if (response.audio) {
                            playAudio(response.audio, function() {
                                if (autoStartRecording) startRecording();
                            });
                        } else if (autoStartRecording) {
                            startRecording();
                        }
                    }
                }).fail(function(xhr) {
                    console.error('Error getting question:', xhr.responseText);
                });
            }

            function startRecording() {
                if (!isRecording && interviewInProgress) {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error('Error starting recognition:', e);
                    }
                }
            }

            function processAnswer(answer) {
                if (!interviewInProgress) return;
                
                stopPauseDetection();
                submittingAnswer = true;
                
                // Capture frame for visual analysis
                const video = document.getElementById('activeCameraFeed');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frameData = canvas.toDataURL('image/jpeg');
                
                $('#submitAnswerBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                
                $.ajax({
                    url: '/submit_answer',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        answer: answer,
                        frame: frameData
                    }),
                    success: function(response) {
                        if (response.status === 'answer_processed') {
                            updateProgress(response.current_question, response.total_questions);
                            
                            if (response.interview_complete) {
                                interviewComplete();
                                const pdfFilename = response.report_pdf_path ? response.report_pdf_path.split('/').pop() : null;
                                if (pdfFilename) {
                                    const downloadUrl = `/download_report/${encodeURIComponent(pdfFilename)}`;
                                    window.open(downloadUrl, '_blank');
                                    $('#downloadReportBtn').show().off('click').on('click', function() {
                                        window.open(downloadUrl, '_blank');
                                    });
                                }
                            } else {
                                setTimeout(askQuestion, 1000);
                            }
                        }
                    },
                    error: function(xhr) {
                        alert('Error processing answer: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    },
                    complete: function() {
                        submittingAnswer = false;
                        $('#submitAnswerBtn').prop('disabled', false).html('Submit Answer');
                    }
                });
            }

            function interviewComplete() {
                interviewInProgress = false;
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                $('#interviewCompleteMessage').show();
                $('#startNewInterviewBtn').show();
                clearInterval(timerInterval);
                document.getElementById('interviewTimer')?.remove();
            }

            // UI helper functions
            function addMessage(speaker, text) {
                const messageClass = speaker === 'bot' ? 'bot-message' : 'user-message';
                const icon = speaker === 'bot' ? '<i class="fas fa-robot me-2"></i>' : '<i class="fas fa-user me-2"></i>';
                
                const messageHtml = `
                    <div class="message ${messageClass} d-flex">
                        ${icon}
                        <div>${text.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
                
                $('#conversationContainer').append(messageHtml);
                $('#conversationContainer').scrollTop($('#conversationContainer')[0].scrollHeight);
            }

            function updateProgress(current, total) {
                let displayCurr = current;
                if (displayCurr > total) displayCurr = total;

                const percent = Math.round((displayCurr / total) * 100);
                $('#progressBar').css('width', `${percent}%`).attr('aria-valuenow', percent);
                $('#progressTextDisplay').text(`${percent}% Complete`);
                $('#currentQuestionNum').text(displayCurr);
                $('#totalQuestions').text(total);
            }

            function playAudio(base64Data, onEndedCallback) {
                if (!base64Data) {
                    if (onEndedCallback) onEndedCallback();
                    return;
                }
                const audio = new Audio('data:audio/wav;base64,' + base64Data);
                audio.play();
                if (onEndedCallback) {
                    audio.onended = onEndedCallback;
                }
            }

            // Event handlers
            $('#micButton').click(function() {
                if (!interviewInProgress) return;
                
                if (isRecording) {
                    if ($(this).hasClass('paused')) {
                        $(this).removeClass('paused');
                        $(this).find('i').removeClass('fa-microphone-slash').addClass('fa-microphone');
                        try {
                            recognition.start();
                        } catch(e) {
                            console.error('Error resuming recognition:', e);
                        }
                    } else {
                        $(this).addClass('paused');
                        $(this).find('i').removeClass('fa-microphone').addClass('fa-microphone-slash');
                        recognition.stop();
                    }
                } else {
                    startRecording();
                }
            });

            $('#submitAnswerBtn').click(function() {
                const answer = $('#answerPreview').text().trim();
                if (!answer) {
                    alert('Please provide an answer before submitting');
                    return;
                }
                processAnswer(answer);
                currentAnswer = '';
                $('#answerPreview').text('');
            });

            $('#endSessionBtn').click(function() {
                if (confirm('Are you sure you want to end the interview session?')) {
                    interviewComplete();
                }
            });

            $('#startNewInterviewBtn').click(function() {
                $.ajax({
                    url: '/reset_interview',
                    type: 'POST',
                    success: function() {
                        location.reload();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON?.message || 'Failed to reset interview'));
                    }
                });
            });

            $('#viewReportBtn').click(function() {
                showInterviewReport();
            });

            $('#printReportBtn').click(function() {
                window.print();
            });

            // Report functions
            let reportModalOpen = false;
            function showInterviewReport() {
                if (reportModalOpen) return;
                
                reportModalOpen = true;
                
                $('#reportContent').html(`
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4>Generating Interview Report</h4>
                        <p class="text-muted">Please wait while we analyze your interview responses...</p>
                    </div>
                `);
                
                var reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                reportModal.show();
                
                $.ajax({
                    url: '/generate_report',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === "success") {
                            $('#reportContent').html(formatReportText(response.report));
                            
                            const statusBadge = `<div class="report-info mb-4">
                                <h4>Interview Summary</h4>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="final-decision decision-${response.status_class}">
                                        ${response.status === "Selected" ? "✅ " : response.status === "On Hold" ? "⏳ " : "❌ "}
                                        ${response.status}
                                    </span>
                                    <span class="badge ${getRatingBadgeClass(response.avg_rating)}">
                                        Average Rating: ${response.avg_rating.toFixed(1)}/10
                                    </span>
                                    <span class="badge bg-secondary">
                                        Duration: ${response.duration}
                                    </span>
                                </div>
                            </div>`;
                            
                            $('#reportContent').prepend(statusBadge);
                            
                            if (response.voice_audio) {
                                playAudio(response.voice_audio);
                            }
                            
                            $('#reportModal').on('hidden.bs.modal', function () {
                                reportModalOpen = false;
                            });
                        } else {
                            $('#reportContent').html(`
                                <div class="alert alert-danger">
                                    <h4>Error Generating Report</h4>
                                    <p>${response.message || 'Failed to generate report. Please try again.'}</p>
                                </div>
                            `);
                            
                            $('#reportModal').on('hidden.bs.modal', function () {
                                reportModalOpen = false;
                            });
                        }
                    },
                    error: function(xhr) {
                        $('#reportContent').html(`
                            <div class="alert alert-danger">
                                <h4>Error Loading Report</h4>
                                <p>${xhr.responseJSON?.message || 'Failed to load report. Please try again.'}</p>
                            </div>
                        `);
                        
                        $('#reportModal').on('hidden.bs.modal', function () {
                            reportModalOpen = false;
                        });
                    }
                });
            }

            function formatReportText(text) {
                return text.replace(/\n/g, '<br>')
                           .replace(/=== (.*?) ===/g, '<h5>$1</h5>')
                           .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }

            function getRatingBadgeClass(rating) {
                if (rating >= 7) return 'bg-success';
                if (rating >= 5) return 'bg-primary';
                if (rating >= 3) return 'bg-warning';
                return 'bg-danger';
            }
        });
    </script>
</body>
</html>